#!/opt/bin/php/bin/php
<?php
declare(strict_types=1);

$taskRootPath = getenv('LAMBDA_TASK_ROOT');

if(!$taskRootPath) {
    echo 'ERROR: THERE is no LAMBDA_TASK_ROOT env set! Please set it or deploy on SAM/Lambda to continue!';
    exit(1);
}

$taskVendorPath = $taskRootPath . '/vendor/autoload.php';
if(!file_exists($taskVendorPath)) {
    echo 'ERROR: There is no vendor dir in your task root! Please run composer install and deploy your function once again!';
    exit(1);
}

/**
 * Include vendors.
 * This is ridiculously important as we do not include phuntime for non-fpm runtimes, this library should be delivered
 * with task dependencies.
 *
 * @noinspection PhpIncludeInspection
 */
require_once $taskVendorPath;

$runtime = \Phuntime\Aws\AwsRuntime::fromEnvironment($_ENV);
$handler = \Phuntime\Core\EventProcessor::fromRuntime($runtime);

try {
    $handler->boot();
} catch (\Throwable $exception) {
    $runtime->handleInitializationException($exception);
    return 1;
}

while (true) {
    $request = $runtime->getNextRequest();
    $handler->handleEvent($request);
}