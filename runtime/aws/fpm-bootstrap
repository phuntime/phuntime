#!/opt/bin/php
<?php
declare(strict_types=1);

use Phuntime\Core\PhpFpmProcess;

/**
 * @noinspection PhpIncludeInspection
 */
require_once __DIR__.'/vendor/autoload.php';

/**
 * FPM requests are handled by using Swoole Coroutine FastCGI Client
 * (@see https://www.swoole.co.uk/docs/modules/swoole-coroutine-fastcgi-client)
 * To make it work properly, we need to run our code in coroutine.
 */

$runtime = \Phuntime\Aws\AwsRuntime::fromEnvironment($_SERVER);

$logger = $runtime->getLogger();
$function = new \Phuntime\Core\FunctionHandler\FpmHandler($runtime->getContext(), $logger);
$handler = \Phuntime\Core\EventProcessor::fromRuntime($runtime, $function);
$fpmProcess = new PhpFpmProcess(
        $logger,
        $_SERVER['FPM_PATH'] ?? '/opt/bin/php-fpm',
        $_SERVER['FPM_CONFIG_PATH'] ?? '/opt/php/php-fpm.conf'
);

try {
    $handler->boot();
    $fpmProcess->start();
} catch (\Throwable $exception) {
    throw $exception;

    $runtime->handleInitializationException($exception);
    return 1;
}


/**
 * All events received by AWS Lambda are received and handled here.
 */
while (true) {
    try {
        /** @var \Phuntime\Aws\Type\ApiGatewayProxyEvent $apiGwEvent */
        $apiGwEvent = $runtime->getNextEvent();
        if(!($apiGwEvent instanceof \Phuntime\Aws\Type\ApiGatewayProxyEvent)) {
            //@TODO: Notify that invalid request happened
        }

        $psrRequest = $apiGwPsr->apiGwToPsr7Request($apiGwEvent);
        $response = $function->handleEvent($psrRequest);
        $proxyResult = $apiGwPsr->psr7ResponseToApiGw($response);
        $runtime->respondToEvent($apiGwEvent->getRequestId(), $proxyResult);
        $fpmProcess->tick();
    } catch (\Throwable $e) {
        throw $e;
        $fpmProcess->stop();
    }
}

return 1;